name: Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - run: sudo apt-get update && sudo apt-get install -y cmake build-essential ninja-build libx11-dev libxrandr-dev libxcursor-dev libxi-dev libudev-dev libgl1-mesa-dev libfreetype6-dev

      - uses: actions/cache@v4
        with:
          path: vcpkg/installed
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: ${{ runner.os }}-vcpkg-

      - run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - run: cmake --build build --parallel $(nproc)

      - run: cd build && ctest --output-on-failure --parallel $(nproc)

      - run: |
          test -f build/bin/r-type_server
          test -f build/bin/r-type_client
          test -f build/bin/test_renderer
          test -f build/bin/test_sparse_array

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - run: brew install cmake ninja

      - uses: actions/cache@v4
        with:
          path: vcpkg/installed
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: ${{ runner.os }}-vcpkg-

      - run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - run: cd build && ctest --output-on-failure --parallel $(sysctl -n hw.ncpu)

      - run: |
          test -f build/bin/r-type_server
          test -f build/bin/r-type_client
          test -f build/bin/test_renderer
          test -f build/bin/test_sparse_array

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: microsoft/setup-msbuild@v2

      - uses: actions/cache@v4
        with:
          path: vcpkg/installed
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: ${{ runner.os }}-vcpkg-

      - run: cmake -B build -DCMAKE_BUILD_TYPE=Release -A x64

      - run: cmake --build build --config Release --parallel

      - run: cd build && ctest -C Release --output-on-failure --parallel

      - shell: pwsh
        run: |
          Test-Path "build\bin\Release\r-type_server.exe"
          Test-Path "build\bin\Release\r-type_client.exe"
          Test-Path "build\bin\Release\test_renderer.exe"
          Test-Path "build\bin\Release\test_sparse_array.exe"

  build-summary:
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    if: always()
    steps:
      - run: |
          [ "${{ needs.build-linux.result }}" = "success" ] && \
          [ "${{ needs.build-macos.result }}" = "success" ] && \
          [ "${{ needs.build-windows.result }}" = "success" ]
