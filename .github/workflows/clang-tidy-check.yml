name: clang-tidy Check

on:
  push:
    branches:
    - main
    - dev
  pull_request:

jobs:
  clang-tidy:
    name: Lint with clang-tidy
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y clang-tidy cmake build-essential ninja-build libx11-dev libxrandr-dev libxcursor-dev libxi-dev libudev-dev libgl1-mesa-dev libfreetype6-dev

    - uses: actions/cache@v4
      with:
        path: vcpkg/installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: ${{ runner.os }}-vcpkg-

    - name: Configure CMake
      run: cmake -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Debug

    - name: Run clang-tidy
      run: |
        FILES=$(find libs/engine libs/network server client tests -type f \( -name "*.hpp" -o -name "*.cpp" \) 2>/dev/null || true)

        if [ -z "$FILES" ]; then
          echo "No files to analyze"
          exit 0
        fi

        for file in $FILES; do
          echo "Analyzing $file..."
          clang-tidy "$file" -p build --quiet --warnings-as-errors='' || true
        done
